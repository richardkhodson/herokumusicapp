/*
 * jQuery Soundcloud Widget
 * 2016 Matt O'Connell <mattoconnell408@gmail.com> 
 * License: MIT
 */
 
!function(a){"use strict";var b=function(b,d){var e=this;e.$el=a(b).addClass("soundcloud loading minimized"),e.$ui={},e.defaults=c,e.player={},e.playlists={data:{},retrieved:0},e.playlist={name:null,user:null,currentID:null,currentIndex:0,tracks:[],trackMap:{}},e.state={playing:!1,poll:null},e.options=a.extend(c,d),e.appendUI(),e.init(d)},c={url:"https://api.soundcloud.com",serverSideScript:"proxy.php",key:null,autoPlay:!1,scrubberSpeed:250};b.prototype.appendUI=function(){function b(){var a=window.innerHeight;a>400&&(a=400),d.$widget.css({height:a+"px"}),d.$widget.css({bottom:"-"+(a-49)+"px"})}function c(b){var c=b.changedTouches[0],e=a(c.target),f=d.$scrubber,g=d.$handle,h=f[0].offsetLeft,i=f[0].offsetWidth;if(e.hasClass("progress")){var j=c.screenX-h;if(j<0&&(j=0),j>i&&(j=i),"touchstart"==b.type&&(d.state.scrubbing=!0),"touchend"==b.type){var k=j/i;d.player.currentTime=d.player.duration*k,d.player.play(),d.state.scrubbing=!1}j+="px",g.css({left:j}),b.preventDefault()}e.hasClass("mini")&&"touchend"==b.type&&d.toggleExpanded()}var d=this,e='<div class="widget soundcloud">    <header class="main">        <section class="mini">            <img alt="" class="icon">            <div class="information">                <h2 class="title">Soundcloud</h2>                <h3 class="subtitle">Loading...</h3>            </div>            <button class="action"></button>        </section>        <section class="controls">            <button class="action"></button>            <button class="back"></button>            <button class="next"></button>        </section>        <section class="progress">            <span class="elapsed">0:12</span>            <div class="scrubber">                <div class="bar"></div>                <div class="handle"></div>            </div>            <span class="remaining">-3:48</span>        </section>    </header>    <div class="container">        <div class="playlist-stage">            <section class="playlists">                <div class="playlists-scroller">                    <a href="#" class="playlist prototype">                        <img src="" alt="" class="cover">                        <h5 class="title">Playlist Title Here</h5>                        <span class="description">11 tracks</span>                    </a>                </div>            </section>            <section class="tracks">                <header class="row">                    <button class="back">Playlists</button>\t\t\t\t\t <h5 class="title">Name</h5>                </header>                <div class="track-wrapper">                    <div class="track-scroller">                        <a href="#" class="row track prototype">                            <h5 class="title">Long Track Title</h5>                            <h6 class="subtitle">Artist Name</h6>                            <span class="duration">3:48</span>                        </a>                    </div>                </div>            </section>        </div>    </div></div>';d.$el.append(e),d.$widget=d.$el.find(".widget"),d.$mini=d.$el.find(".mini"),d.$actionButton=d.$mini.find("button.action"),d.$actionButton.on("click",function(){return d.$widget.hasClass("expanded")?void d.toggleExpanded():void d.togglePlaying()}),d.$actionButton.addClass("play"),d.$miniTitle=d.$mini.find(".title"),d.$miniSubTitle=d.$mini.find(".subtitle"),d.$miniIcon=d.$mini.find(".icon"),d.$miniIcon.attr("src","https://a-v2.sndcdn.com/assets/images/sc-icons/ios-a62dfc8f.png"),d.$controls=d.$el.find(".controls"),d.$mainActionButton=d.$controls.find("button.action"),d.$mainActionButton.on("click",function(){d.togglePlaying()}),d.$mainActionButton.addClass("play"),d.$mainNextButton=d.$controls.find("button.next"),d.$mainNextButton.on("click",function(){var a=d.playlist.currentIndex+1;a>=0&&a<d.playlist.tracks.length&&d.changeTrack(a)}),d.$mainBackButton=d.$controls.find("button.back"),d.$mainBackButton.on("click",function(){var a=d.playlist.currentIndex-1;a>=0&&a<d.playlist.tracks.length&&d.changeTrack(a)}),d.$playlists=d.$el.find(".playlists"),d.$playlistsStage=d.$playlists.find(".playlists-scroller"),d.$playlistsPrototype=d.$playlistsStage.find(".playlist.prototype").clone().removeClass("prototype"),d.$playlistsStage.empty(),d.$tracks=d.$el.find(".tracks"),d.$tracksStage=d.$tracks.find(".track-scroller"),d.$trackPrototype=d.$tracksStage.find(".track.prototype").clone().removeClass("prototype"),d.$tracksStage.empty(),d.$tracks.find("button.back").on("click",function(){d.showPlaylists()}),d.$scrubber=d.$el.find(".scrubber"),d.$handle=d.$el.find(".handle"),d.$remaining=d.$el.find(".remaining"),d.$elapsed=d.$el.find(".elapsed"),window.onresize=b,b(),document.addEventListener("touchstart",c,!0),document.addEventListener("touchmove",c,!0),document.addEventListener("touchend",c,!0),document.addEventListener("touchcancel",c,!0)},b.prototype.init=function(){this.setupPlaylists(function(){var a=this;a.addPlayer();var b=a.$playlists.find(".playlist").eq(0);b.trigger("click");var c=a.$tracks.find(".track").eq(0);c.trigger("click")})},b.prototype.setupPlaylists=function(a){var b=this;b.options.playlists.forEach(function(c){b.options.playlistURL=c,b.getPlaylistData(function(d){d=JSON.parse(d),b.playlists.data[c]=d,b.playlists.retrieved++,b.buildPlaylistGrid(d,c),b.checkIfAllPlaylistsReturned(a)})})},b.prototype.checkIfAllPlaylistsReturned=function(a){var b=this;b.playlists.retrieved==b.options.playlists.length&&(b.$el.removeClass("loading"),a.call(b))},b.prototype.buildPlaylistGrid=function(b,c){var g=this,h=g.$playlistsPrototype.clone(),i=b.artwork_url||b.tracks[0].artwork_url;h.attr("data-pl",c),h.find(".title").text(b.title),h.find(".description").text(b.tracks.length+" tracks"),h.find(".cover").attr("src",d(i));g.$el.find(".track-scroller");h.on("click",function(){return g.$tracksStage.empty(),g.$tracks.find(".title").text(b.title),g.options.playlistURL=a(this).attr("data-pl"),g.assignPlaylistData(g.playlists.data[g.options.playlistURL]),b.tracks.forEach(function(a,b){var c=g.$trackPrototype.clone();c.find(".title").text(a.title),c.find(".subtitle").text(e(a.user.username)),c.find(".duration").text(f(a.duration)),c.on("click",function(){return g.changeTrack(b,!0),!1}),g.$tracksStage.append(c)}),g.showTracks(),!1}),g.$playlistsStage.append(h)},b.prototype.showTracks=function(){var a=this;a.$tracks.addClass("show"),a.$playlists.removeClass("show")},b.prototype.showPlaylists=function(){var a=this;a.$tracks.removeClass("show"),a.$playlists.addClass("show")},b.prototype.toggleExpanded=function(){var a=this;a.$widget.hasClass("expanded")?a.$widget.removeClass("expanded"):a.$widget.addClass("expanded")},b.prototype.togglePlaying=function(){var a=this;a.state.playing?a.player.pause():(a.player.play(),0===a.playlist.currentIndex&&0===a.player.currentTime&&a.startPolling())},b.prototype.getPlaylistData=function(b){var c=this;a.ajax({url:c.options.serverSideScript,data:{url:c.getRequestURL()},success:function(a){b.call(c,a)},error:function(a){console.log(a)}})},b.prototype.addPlayer=function(){var a=this;a.player=new Audio,a.player.addEventListener("play",function(){a.state.playing=!0,a.updateUI()}),a.player.addEventListener("pause",function(){a.state.playing=!1,a.updateUI()}),a.player.addEventListener("ended",function(){a.state.playing=!1;var b=a.playlist.currentIndex+1;return!(b>a.playlist.tracks.length-1)&&(a.changeTrack(b),void a.updateUI())}),a.$el.prepend(a.player)},b.prototype.getRequestURL=function(){var b=this,c=a.param({url:b.options.playlistURL,consumer_key:b.options.key});return decodeURIComponent(b.options.url+"/resolve.json?"+c)},b.prototype.assignPlaylistData=function(a){var b=this;b.playlist.tracks=[],b.playlist.trackMap={};var c=b.playlist;c.name=a.permalink,c.user=a.user.username;var d=0;a.tracks.forEach(function(b){b.streamable&&(c.currentID=c.currentID||a.tracks[0].id,c.tracks.push(b),c.trackMap[b.id]=c.tracks[d],d++)}),b.updateUI()},b.prototype.updateUI=function(){var a=this;a.state.playing?(a.$actionButton.removeClass("play").addClass("pause"),a.$mainActionButton.removeClass("play").addClass("pause")):(a.$actionButton.removeClass("pause").addClass("play"),a.$mainActionButton.removeClass("pause").addClass("play"))},b.prototype.changeTrack=function(a,b){var c=this;a=a||0;var d=c.playlist.tracks[a].id,e=c.playlist.trackMap[d];c.playlist.currentID=d,c.playlist.tracks.forEach(function(b,c){b.id==d&&(a=c)}),c.playlist.currentIndex=a,c.player.src=e.stream_url+"?consumer_key="+c.options.key,b||(c.player.play(),c.startPolling()),c.updateTrackUI(e)},b.prototype.startPolling=function(){var a=this,b=a.$ui.scrubberPlayed;a.state.timer=setInterval(function(){if(a.state.playing&&!a.state.scrubbing){a.$scrubber=a.$el.find(".scrubber"),a.$handle=a.$el.find(".handle");var c=a.player.currentTime/a.player.duration*100;a.$handle.css({left:c+"%"}),isNaN(a.player.duration)||a.$remaining.text("-"+f(1e3*(a.player.duration-a.player.currentTime))),a.$elapsed.text(f(1e3*a.player.currentTime))}else a.player.paused||b.width("100%")},a.options.scrubberSpeed)},b.prototype.updateTrackUI=function(a){var b=this;b.$remaining.text("-"+f(a.duration)),b.$elapsed.text("0:00"),b.$miniIcon.attr("src",d(a.artwork_url)),b.$miniTitle.text(a.title),b.$miniSubTitle.text(e(a.user.username))};var d=function(a){return a=a||"",a.replace("-large","-t500x500")},e=function(a){return a.toLowerCase().split("-").join(" ").split("_").join(" ").split(".").join("").replace("[official]","")},f=function(a){var b=function(a){return{h:Math.floor(a/36e5),m:Math.floor(a/6e4%60),s:Math.floor(a/1e3%60)}}(a),c=[];return b.h>0&&c.push(b.h),c.push(b.m<10&&b.h>0?"0"+b.m:b.m),c.push(b.s<10?"0"+b.s:b.s),c.join(":")};a.fn.soundcloud=function(a){return this.each(function(){new b(this,a)})}}(jQuery);
//# sourceMappingURL=soundcloud-widget.min.js.map